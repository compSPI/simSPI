name: "Linting and Testing (Singularity)"

on:
  push:
    branches: [master,temsim-test-in-container]
    paths-ignore:
    - 'README.md'
    - '.deepsource.toml'
    - '.gitignore'
    - 'setup.py'


  pull_request:
    branches: [master]
    paths-ignore:
    - 'README.md'
    - '.deepsource.toml'
    - '.gitignore'
    - 'setup.py'


jobs:
  build:

    runs-on: ubuntu-18.04
    steps:

      - name: Check Out Repo
        uses: actions/checkout@v2

      - name: Install Singularity
        uses: eWaterCycle/setup-singularity@v7
        with:
           singularity-version: 3.8.3

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: linting [flake8]
        run: >
          singularity exec docker://${{ secrets.DOCKER_HUB_USERNAME }}/simspi:latest
          /bin/bash /opt/entrypoint.sh
          flake8 /work/simSPI /work/tests

      - name: unit testing [pytest]
        run: >
          singularity exec docker://${{ secrets.DOCKER_HUB_USERNAME }}/simspi:latest
          /bin/bash /opt/entrypoint.sh
          pytest --cov-report term --cov-report xml:coverage.xml --cov=/work/simSPI /work/tests

      - name: uploading code coverage [codecov]
        run: >
          bash <(curl -s https://codecov.io/bash) -c